name: Deploy to Server

on:
  # 每次推送到 main 分支时触发
  push:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # 3. 设置 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.4
          run_install: false
      
      # 4. 安装依赖
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      
      # 5. 构建项目
      - name: Build site
        run: pnpm run build
      
      # 6. 部署到服务器
      - name: Deploy to Server via rsync
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          REMOTE_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # 安装 rsync
          sudo apt-get update && sudo apt-get install -y rsync
          
          # 设置 SSH 密钥
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # 添加服务器到 known_hosts
          ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
          
          # 清理旧文件（保留宝塔配置）
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            $REMOTE_USER@$REMOTE_HOST \
            "cd $REMOTE_PATH && find . -mindepth 1 ! -name '.user.ini' ! -name '.htaccess' -delete"
          
          # 使用 rsync 同步文件（排除宝塔保护文件）
          rsync -avz \
            --exclude='.user.ini' \
            --exclude='.htaccess' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            dist/ \
            $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/
          
          # 验证部署
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            $REMOTE_USER@$REMOTE_HOST \
            "ls -la $REMOTE_PATH && echo '部署完成！文件总数:' && find $REMOTE_PATH -type f | wc -l"

