---
import type { GetStaticPaths } from "astro";
import { Icon } from "astro-icon/components";
import MainGridLayout from "../../../layouts/MainGridLayout.astro";
import type { MangaCategory } from "../../../utils/manga-scanner";
import { scanMangaCategories } from "../../../utils/manga-scanner";

export const getStaticPaths = (async () => {
	const categories = await scanMangaCategories();
	return categories.map((category) => ({
		params: { id: category.id },
		props: { category },
	}));
}) satisfies GetStaticPaths;

interface Props {
	category: MangaCategory;
}

const { category } = Astro.props;

if (!category) {
	return Astro.redirect("/404/");
}
---

<MainGridLayout title={category.title} description={category.description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 返回链接 -->
      <a href="/manga/" class="inline-flex items-center text-sm text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] transition mb-4">
        ← 返回漫画分类
      </a>
      
      <!-- 页面标题 -->
      <header class="mb-6">
        <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3 relative flex items-center gap-3
                  before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
          <Icon name="material-symbols:folder-open" class="text-4xl text-[var(--primary)]" />
          {category.title}
        </h1>
        <p class="text-neutral-600 dark:text-neutral-400">
          {category.description}
        </p>
        <div class="text-sm text-neutral-500 dark:text-neutral-500 mt-2">
          共 {category.articles.length} 篇文章
        </div>
      </header>
    </div>
  </div>

  <!-- 文章列表 -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {category.articles.length > 0 ? (
      category.articles.map(article => (
        <div class="card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative group transition-all duration-300">
          <!-- 内容区域 -->
          <div class:list={["pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative", article.image ? "w-full md:w-[calc(100%-28%-12px)]" : "w-full md:w-[calc(100%-52px-12px)]"]}>
            <a href={`/manga/${category.id}/${article.id}/`}
               class="transition group-link w-full block font-bold mb-3 text-3xl text-neutral-900 dark:text-neutral-100
               hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
               active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
               before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
               before:absolute before:top-[35px] before:left-[18px] before:hidden md:before:block">
              {article.title}
              <Icon class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute" name="material-symbols:chevron-right-rounded" />
              <Icon class="text-[var(--primary)] text-[2rem] transition hidden md:inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-1 group-hover:translate-x-0" name="material-symbols:chevron-right-rounded" />
            </a>

            <!-- 元数据 -->
            <div class="flex flex-wrap items-center gap-3 mb-4 text-sm text-neutral-500 dark:text-neutral-500">
              <div class="flex items-center gap-1.5">
                <Icon name="material-symbols:calendar-today-outline-rounded" class="text-lg" />
                <span>{article.published.toLocaleDateString('zh-CN')}</span>
              </div>
              <div class="flex items-center gap-1.5">
                <Icon name="material-symbols:label-outline" class="text-lg" />
                <span>{article.category}</span>
              </div>
            </div>

            <!-- 描述 -->
            <div class="text-neutral-600 dark:text-neutral-400 mb-3.5 pr-4 line-clamp-2 md:line-clamp-1">
              {article.description}
            </div>

            <!-- 标签 -->
            <div class="flex flex-wrap gap-2 mt-2">
              {article.tags && article.tags.length > 0 && article.tags.map(tag => (
                <span class="text-xs px-2 py-1 rounded-lg bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors">
                  #{tag}
                </span>
              ))}
            </div>
          </div>

          <!-- 封面图片区域 (右侧) -->
          {article.image && (
            <a href={`/manga/${category.id}/${article.id}/`} 
               aria-label={article.title}
               class="group max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0 md:w-[28%] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95">
              <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition"></div>
              <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center">
                <Icon name="material-symbols:chevron-right-rounded"
                      class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl" />
              </div>
              <img 
                src={article.image} 
                alt={article.title}
                class="w-full h-full object-cover"
              />
            </a>
          )}

          <!-- 无封面时的进入按钮 -->
          {!article.image && (
            <a href={`/manga/${category.id}/${article.id}/`} 
               aria-label={article.title} 
               class="!hidden md:!flex btn-regular w-[3.25rem] absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)] hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95">
              <Icon name="material-symbols:chevron-right-rounded"
                    class="transition text-[var(--primary)] text-4xl mx-auto" />
            </a>
          )}
        </div>
      ))
    ) : (
      <div class="col-span-full card-base px-8 py-12">
        <p class="text-center text-neutral-500 dark:text-neutral-400">
          该分类暂无文章
        </p>
      </div>
    )}
  </div>
</MainGridLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

