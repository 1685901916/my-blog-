---
import path from "node:path";
import * as fs from "node:fs";
import type { GetStaticPaths } from "astro";
import Comment from "@components/comment/index.astro";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
import PostMetadata from "../../../../components/PostMeta.astro";
import { profileConfig, siteConfig, licenseConfig } from "../../../../config";
import { scanMangaCategories } from "../../../../utils/manga-scanner";
import { formatDateToYYYYMMDD } from "../../../../utils/date-utils";

export const getStaticPaths = (async () => {
	const categories = await scanMangaCategories();
	const paths = [];

	for (const category of categories) {
		for (const article of category.articles) {
			paths.push({
				params: {
					categoryId: category.id,
					articleId: article.id,
				},
				props: {
					category,
					article,
				},
			});
		}
	}

	return paths;
}) satisfies GetStaticPaths;

interface Props {
	category: any;
	article: any;
}

const { category, article } = Astro.props;

if (!category || !article) {
	return Astro.redirect("/404/");
}

// 读取文章内容
const articlePath = path.join(
	process.cwd(),
	"src/content/manga-categories",
	category.id,
	`${article.id}.md`,
);

let articleContent = "";
if (fs.existsSync(articlePath)) {
	const fileContent = fs.readFileSync(articlePath, "utf-8");
	// 手动分离 front matter 和内容
	const contentMatch = fileContent.match(
		/^---\s*\n[\s\S]*?\n---\s*\n([\s\S]*)$/,
	);
	const content = contentMatch ? contentMatch[1] : fileContent;
	// 简单的 Markdown 处理（可以后续改进）
	const { marked } = await import("marked");
	articleContent = marked(content) as string;
}

const jsonLd = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: article.title,
	description: article.description || article.title,
	keywords: article.tags,
	author: {
		"@type": "Person",
		name: profileConfig.name,
		url: Astro.site,
	},
	datePublished: formatDateToYYYYMMDD(article.published),
	inLanguage: article.lang
		? article.lang.replace("_", "-")
		: siteConfig.lang.replace("_", "-"),
};
---

<MainGridLayout
	title={article.title}
	description={article.description}
	banner={article.image}
>
	<script
		slot="head"
		type="application/ld+json"
		set:html={JSON.stringify(jsonLd)}
	/>

	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div
			id="post-container"
			class:list={[
				"card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ",
			]}
		>
			<!-- 面包屑导航 -->
			<a
				href={`/manga/${category.id}/`}
				class="transition text-50 text-sm font-medium mb-3 inline-flex items-center gap-1 hover:text-[var(--primary)]"
			>
				<Icon name="material-symbols:chevron-left-rounded" class="text-xl" />
				返回{category.title}
			</a>

			<!-- 标题 -->
			<div class="flex items-start justify-between mb-4">
				<h1
					class="transition text-4xl font-bold text-neutral-900 dark:text-neutral-100"
				>
					{article.title}
				</h1>
			</div>

			<!-- 元数据 - 使用和独立文章完全一样的组件 -->
			<PostMetadata
				published={article.published}
				updated={undefined}
				tags={article.tags || []}
				category={article.category || "漫画"}
				slug={`${category.id}/${article.id}`}
				words={article.words || 0}
			/>

			<!-- 封面图片 -->
			{
				article.image && (
					<img
						src={article.image}
						alt={article.title}
						class="w-full my-8 rounded-xl object-cover"
					/>
				)
			}

			<!-- 文章内容 -->
			<Markdown class="mt-8 mb-6">
				<div set:html={articleContent}></div>
			</Markdown>

			<!-- 版权信息 -->
			{licenseConfig?.enable && (
				<License
					title={article.title}
					slug={`${category.id}/${article.id}`}
					pubDate={article.published}
					author={article.author}
					sourceLink={article.sourceLink}
					licenseName={article.licenseName}
					licenseUrl={article.licenseUrl}
					class="mb-6 rounded-xl license-container"
				/>
			)}

			<!-- 评论区 -->
			{siteConfig?.comment?.enable && <Comment />}
		</div>
	</div>
</MainGridLayout>
