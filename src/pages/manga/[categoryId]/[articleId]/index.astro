---
import type { GetStaticPaths } from "astro";
import MainGridLayout from "../../../../layouts/MainGridLayout.astro";
import { scanMangaCategories } from "../../../../utils/manga-scanner";
import * as fs from "node:fs";
import * as path from "node:path";
import { marked } from "marked";

export const getStaticPaths = (async () => {
	const categories = await scanMangaCategories();
	const paths = [];

	for (const category of categories) {
		for (const article of category.articles) {
			paths.push({
				params: { 
					categoryId: category.id,
					articleId: article.id
				},
				props: { 
					category,
					article
				},
			});
		}
	}

	return paths;
}) satisfies GetStaticPaths;

interface Props {
	category: any;
	article: any;
}

const { category, article } = Astro.props;

if (!category || !article) {
	return Astro.redirect("/404/");
}

// è¯»å–æ–‡ç« å†…å®¹
const articlePath = path.join(
	process.cwd(), 
	"src/content/manga-categories",
	category.id,
	`${article.id}.md`
);

let articleContent = "";
if (fs.existsSync(articlePath)) {
	const fileContent = fs.readFileSync(articlePath, "utf-8");
	// æ‰‹åŠ¨åˆ†ç¦» front matter å’Œå†…å®¹
	const contentMatch = fileContent.match(/^---\s*\n[\s\S]*?\n---\s*\n([\s\S]*)$/);
	const content = contentMatch ? contentMatch[1] : fileContent;
	articleContent = marked(content) as string;
}
---

<MainGridLayout title={article.title} description={article.description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <nav class="text-sm text-neutral-600 dark:text-neutral-400 mb-6 flex items-center gap-2">
        <a href="/manga/" class="hover:text-[var(--primary)] transition">æ¼«ç”»</a>
        <span>/</span>
        <a href={`/manga/${category.id}/`} class="hover:text-[var(--primary)] transition">{category.title}</a>
        <span>/</span>
        <span class="text-neutral-900 dark:text-neutral-100">{article.title}</span>
      </nav>

      <!-- æ–‡ç« å¤´éƒ¨ -->
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-neutral-900 dark:text-neutral-100 mb-4">
          {article.title}
        </h1>
        
        {article.description && (
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-4">
            {article.description}
          </p>
        )}

        <div class="flex flex-wrap gap-4 text-sm text-neutral-500 dark:text-neutral-500 mb-4">
          <div class="flex items-center gap-2">
            <span>ğŸ“…</span>
            <span>{article.published.toLocaleDateString('zh-CN')}</span>
          </div>
          <div class="flex items-center gap-2">
            <span>ğŸ“</span>
            <span>{category.title}</span>
          </div>
        </div>

        {article.tags && article.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {article.tags.map((tag: string) => (
              <span class="text-xs px-3 py-1 rounded-full bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400">
                #{tag}
              </span>
            ))}
          </div>
        )}
      </header>

      {article.image && (
        <div class="mb-8 rounded-lg overflow-hidden">
          <img 
            src={article.image} 
            alt={article.title}
            class="w-full h-auto"
          />
        </div>
      )}

      <!-- æ–‡ç« å†…å®¹ -->
      <article class="prose prose-neutral dark:prose-invert max-w-none">
        <div set:html={articleContent}></div>
      </article>

      <!-- è¿”å›æŒ‰é’® -->
      <div class="mt-12 pt-8 border-t border-neutral-200 dark:border-neutral-800">
        <a href={`/manga/${category.id}/`} 
           class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition">
          â† è¿”å› {category.title}
        </a>
      </div>
    </div>
  </div>
</MainGridLayout>

