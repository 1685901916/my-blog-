---
import path from "node:path";
import Comment from "@components/comment/index.astro";
import License from "@components/misc/License.astro";
import Markdown from "@components/misc/Markdown.astro";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getDir } from "@utils/url-utils";
import { Icon } from "astro-icon/components";
import { licenseConfig } from "src/config";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";
import PostMetadata from "../../components/PostMeta.astro";
import { profileConfig, siteConfig } from "../../config";
import { getCollection } from "astro:content";
import { formatDateToYYYYMMDD } from "../../utils/date-utils";

export async function getStaticPaths() {
	const mangaEntries = await getCollection("manga", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});
	
	return mangaEntries.map((entry) => ({
		params: { slug: entry.slug },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { remarkPluginFrontmatter } = await entry.render();

const jsonLd = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: entry.data.title,
	description: entry.data.description || entry.data.title,
	keywords: entry.data.tags,
	author: {
		"@type": "Person",
		name: profileConfig.name,
		url: Astro.site,
	},
	datePublished: formatDateToYYYYMMDD(entry.data.published),
	inLanguage: entry.data.lang
		? entry.data.lang.replace("_", "-")
		: siteConfig.lang.replace("_", "-"),
};
---

<MainGridLayout
	title={entry.data.title}
	description={entry.data.description || remarkPluginFrontmatter.excerpt}
	banner={entry.data.image}
>
	<script
		slot="head"
		type="application/ld+json"
		set:html={JSON.stringify(jsonLd)}
	/>

	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div
			id="post-container"
			class:list={[
				"card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full ",
			]}
		>
			<!-- 面包屑导航 -->
			<a
				href="/manga/"
				class="transition text-50 text-sm font-medium mb-3 inline-flex items-center gap-1 hover:text-[var(--primary)]"
			>
				<Icon name="material-symbols:chevron-left-rounded" class="text-xl" />
				返回漫画列表
			</a>

			<!-- 标题 -->
			<div class="flex items-start justify-between mb-4">
				<h1
					class="transition text-4xl font-bold text-neutral-900 dark:text-neutral-100"
				>
					{entry.data.title}
				</h1>
			</div>

			<!-- 元数据 -->
			<PostMetadata
				published={entry.data.published}
				updated={entry.data.updated}
				tags={entry.data.tags}
				category={entry.data.category}
				slug={entry.slug}
				words={remarkPluginFrontmatter.words}
			/>

			<!-- 封面图片 -->
			{
				entry.data.image && (
					<ImageWrapper
						src={entry.data.image}
						basePath={path.join("content/manga/", getDir(entry.id))}
						class="w-full my-8 rounded-xl"
						alt="封面图片"
					/>
				)
			}

			<!-- 文章内容 -->
			<Markdown class="mt-8 mb-6">
				<Content />
			</Markdown>

			<!-- 版权信息 -->
			{licenseConfig?.enable && (
				<License
					title={entry.data.title}
					slug={entry.slug}
					pubDate={entry.data.published}
					author={entry.data.author}
					sourceLink={entry.data.sourceLink}
					licenseName={entry.data.licenseName}
					licenseUrl={entry.data.licenseUrl}
					class="mb-6 rounded-xl license-container"
				/>
			)}

			<!-- 评论区 -->
			{siteConfig?.comment?.enable && <Comment />}
		</div>
	</div>
</MainGridLayout>

image.png