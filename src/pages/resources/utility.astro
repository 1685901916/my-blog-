---
import { getCollection } from "astro:content";
import ImageWrapper from "@components/misc/ImageWrapper.astro";
import PostMetadata from "@components/PostMeta.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getTagUrl } from "@utils/url-utils";
import { Icon } from "astro-icon/components";

// 获取所有分类为"实用工具"的文章
const allPosts = await getCollection("posts", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
});

// 筛选出实用工具分类的文章
const utilityPosts = allPosts.filter(
	(post) => post.data.category === "实用工具",
);

// 转换为统一格式并计算字数
const articles = await Promise.all(
	utilityPosts.map(async (entry) => {
		const { remarkPluginFrontmatter } = await entry.render();
		return {
			id: entry.slug,
			title: entry.data.title,
			description: entry.data.description,
			image: entry.data.image,
			tags: entry.data.tags,
			category: entry.data.category,
			published: entry.data.published,
			slug: entry.slug,
			words: remarkPluginFrontmatter.words || 0,
		};
	}),
);

// 按发布日期排序
articles.sort((a, b) => b.published.getTime() - a.published.getTime());
---

<MainGridLayout banner={undefined} title="实用工具">
    <!-- 双列布局 - 与漫画页面一致 -->
    <div class="transition grid grid-cols-1 md:grid-cols-2 rounded-[var(--radius-large)] bg-[var(--card-bg)] py-0 md:py-0 md:bg-transparent gap-2 md:gap-4 mb-4">
        {articles.map((article) => (
            <div class="card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative">
                <div class:list={["pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative", article.image ? "w-full md:w-[calc(100%-28%-12px)]" : "w-full md:w-[calc(100%-52px-12px)]"]}>
                    <a href={`/posts/${article.slug}/`}
                       class="transition group w-full block font-bold mb-3 text-3xl text-90
                       hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
                       active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
                       before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
                       before:absolute before:top-[35px] before:left-[18px] before:hidden md:before:block">
                        {article.title}
                        <Icon class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute" name="material-symbols:chevron-right-rounded" />
                        <Icon class="text-[var(--primary)] text-[2rem] transition hidden md:inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-1 group-hover:translate-x-0" name="material-symbols:chevron-right-rounded" />
                    </a>

                    <!-- metadata -->
                    <PostMetadata
                        published={article.published}
                        updated={undefined}
                        tags={article.tags || []}
                        category={article.category || '实用工具'}
                        hideTagsForMobile={true}
                        hideUpdateDate={true}
                        className="mb-4"
                        showOnlyBasicMeta={true}
                        words={article.words}
                        showWordCount={true}
                    />

                    <!-- description -->
                    <div class="transition text-75 mb-3.5 pr-4 line-clamp-2">
                        {article.description}
                    </div>

                    <!-- tags -->
                    <div class="flex flex-wrap gap-2 mt-2">
                        {article.tags && article.tags.length > 0 && article.tags.map((tag: string) => (
                            <a
                                href={getTagUrl(tag)}
                                class="link-lg transition text-50 text-xs font-medium px-2 py-1 rounded-lg hover:text-[var(--primary)] dark:hover:text-[var(--primary)] active:text-[var(--primary)] dark:active:text-[var(--primary)] group/tag whitespace-nowrap"
                                aria-label={`View all posts tagged with ${tag.trim()}`}
                            >
                                <span class="transition-transform group-hover/tag:translate-x-0.5">
                                    # {tag.trim()}
                                </span>
                            </a>
                        ))}
                    </div>
                </div>

                {/* 封面图片 */}
                {article.image && (
                    <a href={`/posts/${article.slug}/`} aria-label={article.title}
                       class="group max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0 md:w-[28%] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95">
                        <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition"></div>
                        <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center">
                            <Icon name="material-symbols:chevron-right-rounded" class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl" />
                        </div>
                        <ImageWrapper src={article.image} alt={article.title} class="w-full h-full object-cover" />
                    </a>
                )}

                {/* 无封面时的按钮 */}
                {!article.image && (
                    <a href={`/posts/${article.slug}/`} aria-label={article.title}
                       class="!hidden md:!flex btn-regular w-[3.25rem] absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)] hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95">
                        <Icon name="material-symbols:chevron-right-rounded" class="transition text-[var(--primary)] text-4xl mx-auto" />
                    </a>
                )}
            </div>
        ))}

        {/* 空状态 */}
        {articles.length === 0 && (
            <div class="card-base px-8 py-12">
                <p class="text-center text-neutral-500 dark:text-neutral-400">暂无实用工具内容</p>
            </div>
        )}
    </div>
</MainGridLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>








