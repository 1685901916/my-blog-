<!-- 940a4c40-bad1-4e3a-b6cc-9bbe82d226ec 90cd4b28-f4d7-4aca-a811-ec68098653da -->
# 服务器部署修复方案

## 问题诊断

当前问题：GitHub Actions 显示部署成功，但服务器目录 `/www/wwwroot/blog` 为空。

根本原因：服务器的 `~/.ssh/authorized_keys` 文件为空，导致 GitHub Actions 无法通过 SSH 连接服务器传输文件。

## 修复步骤

### 步骤 1：修复服务器 SSH 公钥配置

**在 FinalShell 终端执行以下命令：**

```bash
# 1. 添加 GitHub Actions 的公钥到 authorized_keys
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDl+35czWpIpoguZawIyTE8VQhH6aLmqVszueEVTRKj0mtQUAK9O6agIts7nnWh1p58JIsugQ5G1zYh04bXujLO6b90LcaPN1tUUuJyIW1mXfaVV+WQp8kmQ6d8+MeilnWxlR/AS50FXcrVJaOc0nOn6nIbR9BmdvuPWOCe1CzlaNYBSQIYznQQwSAijJ4iIsQ2H4VGleO+7YsjpyuOxRXz0mcoofPchZV0zK+z9djxIsoV4Pv5MqdXTLyy2/GCexaplP0KMgKvaWvuXz9rVOS0sWlSSP2aOtVI8wVpxxj+JYac7At4cq4EbxMf4WyrmCrPYF1qFwVukWONwUCS61JHeaIg5M0BsMjVXiYSNjgaxJPw5FLGBPD23N3FY+YevVICdVAeTPMjZWa0zHzyv3UZwKs4hnUZxcEfmwnt8lFmPY8rYTi8p18a5f1W4WsDkxK/VuIAmipqswBAMagNnXNgtDXTkjikOx+Dk7vn7nJNr2nWXtrAHCzS517OZumVnBSbAnrsWbUqMuqabWjlWn6FXgB7lVzOC6fO3n8oSHILJsyuRYvWv38/4Hegrv0TRKlzB2zl22xR35bHCy78zqZBH5RgoCBjVxtQoqa9hxcL3rXkhcwFyB4z0AfXZsr5zEtgFVnIAvPPRbfw9YtEtF3Hdkqsc4tt/jj7cGxLVCbw== github-actions" > ~/.ssh/authorized_keys

# 2. 设置正确的权限
chmod 600 ~/.ssh/authorized_keys

# 3. 验证公钥已添加
cat ~/.ssh/authorized_keys

# 4. 确保目标目录存在且有正确权限
mkdir -p /www/wwwroot/blog
chmod 755 /www/wwwroot/blog
```

**预期结果：**

- `cat ~/.ssh/authorized_keys` 应该显示完整的公钥内容
- 目录 `/www/wwwroot/blog` 已创建

### 步骤 2：重新触发 GitHub Actions 部署

**在本地执行：**

```bash
cd "D:\cursor\project8  blog\Mizuki-master"
git commit --allow-empty -m "重新触发部署"
git push
```

**预期结果：**

- GitHub Actions 自动触发
- 构建并通过 SSH 将 dist 目录内容传输到服务器

### 步骤 3：验证部署成功

**检查 1：GitHub Actions 状态**

- 访问 https://github.com/1685901916/my-blog-/actions
- 点击最新的 "Deploy to Server" 工作流
- 查看 "Deploy to Server" 步骤的日志，确认文件传输成功

**检查 2：服务器文件**

在 FinalShell 执行：

```bash
ls -la /www/wwwroot/blog/
```

应该能看到：

- `index.html`
- `_astro/` 目录
- 其他静态文件

### 步骤 4：配置 Nginx（如果尚未配置）

**在宝塔面板：**

1. 左侧菜单 → "网站"
2. 找到 `ayano29.cn` 网站（根目录：`/www/wwwroot/blog`）
3. 点击 "设置"
4. 左侧 "域名管理" → 添加域名：`156.225.28.187`
5. 保存

**或者创建新网站：**

- 域名：`156.225.28.187`
- 根目录：`/www/wwwroot/blog`
- PHP 版本：纯静态

### 步骤 5：访问网站验证

在浏览器访问：

```
http://156.225.28.187
```

应该能看到你的博客首页。

## 后续使用流程

**每次更新博客：**

```bash
# 1. 本地编辑文章或样式
编辑 src/content/posts/xxx.md

# 2. 提交到 GitHub
git add .
git commit -m "新增文章"
git push

# 3. 等待 1-2 分钟
GitHub Actions 自动构建并部署到服务器

# 4. 刷新网站查看更新
http://156.225.28.187
```

## 故障排查

### 如果 GitHub Actions 失败

查看详细日志：

1. 访问 https://github.com/1685901916/my-blog-/actions
2. 点击失败的工作流
3. 查看 "Deploy to Server" 步骤
4. 检查 SSH 连接错误或权限问题

常见错误：

- `Permission denied (publickey)` → 公钥未正确添加
- `rsync: failed to set times` → 目录权限问题

### 如果网站显示 403 Forbidden

在 FinalShell 执行：

```bash
# 检查文件权限
ls -la /www/wwwroot/blog/

# 修复权限
chmod -R 755 /www/wwwroot/blog/
chown -R www:www /www/wwwroot/blog/

# 检查 SELinux（如果启用）
getenforce
# 如果是 Enforcing，临时关闭测试
setenforce 0
```

## 配置文件说明

工作流文件位置：`.github/workflows/deploy-to-server.yml`

关键配置：

- 使用 `easingthemes/ssh-deploy@main` 进行 SSH 部署
- 部署源：`dist/` 目录
- 部署目标：`/www/wwwroot/blog`
- 使用 rsync 传输，参数 `-avz --delete`

### To-dos

- [ ] 在服务器添加 SSH 公钥到 authorized_keys 并设置权限
- [ ] 创建空提交并推送到 GitHub，触发自动部署
- [ ] 检查服务器 /www/wwwroot/blog 目录是否有文件
- [ ] 在宝塔面板配置 Nginx 网站指向正确目录
- [ ] 访问 http://156.225.28.187 验证网站是否正常显示